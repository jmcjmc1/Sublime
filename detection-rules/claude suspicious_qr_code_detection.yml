name: Suspicious QR Code in Attachment
description: |
  Detects inbound messages containing QR codes in attachments with suspicious characteristics.
  This advanced rule flags QR codes that decode to URLs, particularly those that may pose 
  a credential phishing risk. The rule uses file analysis to scan attachments and identifies 
  QR codes pointing to external URLs (not in organizational domains). This helps security teams 
  quickly identify and investigate potential QR code-based phishing campaigns while minimizing 
  false positives from legitimate business QR code usage.
references:
  - https://sublime.security/blog/qr-code-phishing-decoding-hidden-threats/
  - https://docs.sublime.security/docs/yaml-files
authors:
  - name: Custom Detection Team
type: rule
severity: high
tags:
  - qr_code
  - phishing
  - attachment
  - credential_theft
attack_types:
  - Credential Phishing
  - Callback Phishing
tactics_and_techniques:
  - QR code
  - Evasion
  - Social engineering
detection_methods:
  - QR code analysis
  - File analysis
  - URL analysis
false_positives:
  - Legitimate QR codes used for internal authentication or MFA requests
  - Trusted business partners using QR codes for standard workflows
  - QR codes pointing to well-known, trusted domains (Microsoft, Google, etc.)
source: |
  type.inbound
  and length(attachments) <= 5
  and any(
    attachments,
    (
      .file_type in $file_types_images 
      or .file_type == "pdf"
    )
    and any(
      file.explode(.),
      .scan.qr.type == "url"
      and .scan.qr.url is not null
      and not .scan.qr.url.domain.root_domain in $org_domains
    )
  )
